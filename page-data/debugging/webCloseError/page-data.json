{"componentChunkName":"component---src-templates-post-template-tsx","path":"/debugging/webCloseError/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>프로젝트를 진행하던 중, 사용자가 브라우저 창을 닫아도 로그인이 유지되는 문제가 발생했습니다. 그리고 숨겨진 페이지의 URL을 직접 입력해서 이동할 경우 로그아웃되는 문제도 발견했습니다.\r\n이 문제를 해결하기 위해 beforeunload 이벤트, 로컬스토리지, 세션스토리지를 사용해가며 해결했습니다.</p>\n</blockquote>\n<h3>1. 첫 번째 시도: beforeunload 사용</h3>\n<p> beforeunload 이벤트는 사용자가 창을 닫으려 할 때 <strong>“저장되지 않은 내용이 있습니다. 정말 나가시겠습니까?”</strong> 와 같은 경고창을 띄울 때 자주 사용되는 함수입니다.<br/>\r\n저는 이 함수를 사용해 브라우저 창이 닫힐 때 자동으로 로그아웃되도록 하려고 했습니다. 아래는 beforeunload를 사용한 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'beforeunload'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">ev</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    ev<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ev<span class=\"token punctuation\">.</span>returnValue <span class=\"token operator\">=</span> <span class=\"token string\">'Are you sure you want to close?'</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> userSavedData <span class=\"token operator\">=</span> localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'userData'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userSavedData <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'beforeunload'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">.</span><span class=\"token function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p> 처음에는 창을 닫거나 페이지를 이동할 때 경고를 띄워주는 기능을 통해, 창이 닫힐 때 로그아웃이 되도록 설정하면 문제를 해결할 수 있을 것이라고 생각했습니다. <br/>\r\n그러나 beforeunload는 창닫기, 페이지 이동, 새로고침의 경우를 구분하지 못하기 때문에, 모든 브라우저 상태 변화에서 로그아웃이 발생하는 문제가 있었습니다.</p>\n<h3>2. 두 번째 시도: beforeunload에 조건문 추가하여 브라우저 상태 구분하기</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleBeforeUnload</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> navEntries <span class=\"token operator\">=</span> performance<span class=\"token punctuation\">.</span><span class=\"token function\">getEntriesByType</span><span class=\"token punctuation\">(</span><span class=\"token string\">'navigation'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> navEntry <span class=\"token operator\">=</span> navEntries<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> navEntries<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">hasFocus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> navEntry <span class=\"token operator\">&amp;&amp;</span> navEntry<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">'reload'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">handleLogout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n      event<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n      event<span class=\"token punctuation\">.</span>returnValue <span class=\"token operator\">=</span> <span class=\"token string\">''</span> <span class=\"token comment\">// 일부 브라우저에서 필요</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'beforeunload'</span><span class=\"token punctuation\">,</span> handleBeforeUnload<span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleUnload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 창이 닫힐 때만 로그아웃 처리</span>\r\n    <span class=\"token function\">handleLogout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unload'</span><span class=\"token punctuation\">,</span> handleUnload<span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'beforeunload'</span><span class=\"token punctuation\">,</span> handleBeforeUnload<span class=\"token punctuation\">)</span>\r\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unload'</span><span class=\"token punctuation\">,</span> handleUnload<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p> 이 코드는 beforeunload와 unload 이벤트를 사용해 창을 닫을 때와 새로고침할 때 각각 구분하여 처리했습니다.\r\n하지만 창닫기, 페이지 이동, 새로고침의 세 가지 경우를 정확히 구분하지 못해 문제는 해결되지 않았습니다.</p>\n<h3>3. 세 번째 시도: 세션 스토리지를 활용한 해결책</h3>\n<p> 문뜩 로그아웃이 안되는건 로컬에 로그인에 대한 정보가 저장이 되어있어서 그런게 아닐까라는 생각이 들었고, 실제로 프로젝트에서 로컬 스토리지를 사용하고 있다는 점을 확인했습니다.\r\n그래서 세션 스토리지를 활용하여 창이 닫혔을 때 자동으로 로그아웃되도록 시도했습니다.<br/>\r\n🔗 [참고] (<a href=\"https://ellajang.github.io/basicResource/storage/\" target=\"_blank\" rel=\"nofollow\">https://ellajang.github.io/basicResource/storage/</a>)\r\n<br/><br/></p>\n<h4>📍 로컬 스토리지와 세션 스토리지의 비교</h4>\n<p><strong>로컬 스토리지</strong></p>\n<ul>\n<li>창을 닫아도 데이터가 남아있습니다.</li>\n<li>새로고침을 해도 데이터가 유지됩니다.</li>\n<li>다른 페이지로 이동해도 데이터가 유지됩니다.</li>\n</ul>\n<p><strong>세션 스토리지</strong></p>\n<ul>\n<li>창을 닫으면 데이터가 초기화됩니다.</li>\n<li>새로고침을 해도 데이터가 유지됩니다.</li>\n<li>다른 페이지로 이동해도 데이터가 유지됩니다.</li>\n</ul>\n<p> 따라서 세션 스토리지에 로그인 상태를 저장하면 창을 닫았을 때 자동으로 로그아웃될 수 있다고 판단했습니다.</p>\n<p><br/><br/></p>\n<blockquote>\n<h5>Redux 상태를 세션 스토리지에 저장하기</h5>\n</blockquote>\n<p> 프로젝트에서 redux로 상태를 관리하고 있기 때문에 redux-persist 라이브러리를 사용해 리덕스 상태를 세션 스토리지에 저장하도록 설정했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  yarn add redux<span class=\"token operator\">-</span>persist</code></pre></div>\n<p>  다음은 store 관리 폴더에서 persist 설정을 적용한 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> combineReducers<span class=\"token punctuation\">,</span> configureStore <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@reduxjs/toolkit'</span>\r\n<span class=\"token keyword\">import</span> storageSession <span class=\"token keyword\">from</span> <span class=\"token string\">'redux-persist/lib/storage/session'</span>\r\n\r\n<span class=\"token keyword\">const</span> rootReducer <span class=\"token operator\">=</span> <span class=\"token function\">combineReducers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  auth<span class=\"token punctuation\">,</span>\r\n  user<span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">const</span> persistConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token literal-property property\">key</span><span class=\"token operator\">:</span> <span class=\"token string\">'root'</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token literal-property property\">storage</span><span class=\"token operator\">:</span> storageSession<span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">// blacklist: [\"\"]  // 유지할 필요 없는 상태를 제외</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">const</span> persistedReducer <span class=\"token operator\">=</span> <span class=\"token function\">persistReducer</span><span class=\"token punctuation\">(</span>persistConfig<span class=\"token punctuation\">,</span> rootReducer<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">configureStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token literal-property property\">reducer</span><span class=\"token operator\">:</span> persistedReducer<span class=\"token punctuation\">,</span>\r\n  <span class=\"token function-variable function\">middleware</span><span class=\"token operator\">:</span> <span class=\"token parameter\">getDefaultMiddleware</span> <span class=\"token operator\">=></span>\r\n    <span class=\"token function\">getDefaultMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token literal-property property\">serializableCheck</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> persistor <span class=\"token operator\">=</span> <span class=\"token function\">persistStore</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span></code></pre></div>\n<p> 그리고, _app.js 파일에 PersistGate를 추가해 Redux 상태를 세션 스토리지에 저장하도록 설정했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> persistor<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n\r\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token operator\">&lt;</span>Provider store<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>store<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\r\n    <span class=\"token operator\">&lt;</span>PersistGate loading<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">}</span> persistor<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>persistor<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span>React<span class=\"token punctuation\">.</span>StrictMode<span class=\"token operator\">></span>\r\n        <span class=\"token operator\">&lt;</span>ThemeProvider theme<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>theme<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\r\n          <span class=\"token operator\">&lt;</span>App <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n          <span class=\"token operator\">&lt;</span>ToastContainer <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ThemeProvider<span class=\"token operator\">></span>\r\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>React<span class=\"token punctuation\">.</span>StrictMode<span class=\"token operator\">></span>\r\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>PersistGate<span class=\"token operator\">></span>\r\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Provider<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p> 마지막으로, 기존에 로컬 스토리지에 저장되어 있던 데이터를 세션 스토리지로 변경했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> userData <span class=\"token operator\">=</span> sessionStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span>authConfig<span class=\"token punctuation\">.</span>userData<span class=\"token punctuation\">)</span> <span class=\"token comment\">//localStorage에서 sessionStorage로 변경</span></code></pre></div>\n<p>위와 같은 방법으로 해결했습니다.\r\n<br/><br/>\r\n📍 <strong>추가로 중요한점</strong> <br/>\r\n 세션 스토리지를 활용할 경우, 서버의 최신 데이터를 동기화하기 위한 추가 작업이 필요합니다. redux-persist 는 로컬에 있는 데이터를 우선적으로 보여주기 때문에, 서버에서 최근의 데이터를 불러와야 하는 곳이라면 유의해서 비동기 액션을 추가하여 새로고침 시 서버로부터 데이터를 불러오는 것이 중요합니다.</p>\n<h3>4. 마무리</h3>\n<p> 이 문제는 단순히 브라우저 창을 닫는 것을 감지하는 것만으로 해결되지 않았습니다. <br/>로컬 스토리지 대신 세션 스토리지를 사용하고, Redux 상태를 세션 스토리지에 저장하여 창을 닫았을 때 로그아웃을 처리했습니다. 추가로 서버와의 데이터 동기화를 통해 새로고침 후에도 최신 데이터를 유지하도록 설정함으로써 최종적으로 문제를 해결할 수 있었습니다.</p>","frontmatter":{"title":"로그인 후 창을 닫아도 로그인 유지 문제","summary":"로그인 후 사용자가 브라우저 창을 닫아도 로그인이 유지되는 문제를 해결한 방법에 대한 설명입니다.(로컬스토리지와 세션스토리지)","date":"2024.06.17.","categories":["All"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA60lEQVR42p2SO07DQBRFvRca9kFBwxbYDhVrYBFQBs/YE7BSICQLhJQPno/tyURKEBXQoIPsuKBInE9x9TR6elfvnbmRkZ7dqjv5f3Wzor0MRcDIOTat23qUoW4kmuESp95w6hWnXjDSoXtMo74ztVjgVE6dDVjlV/hRSqme0e3GBxmuT7NJQfWQ8T07gxDxYy+os0dsMsHIsJHnVsNCBFw6pRrGfE1P4fOcX3/CfHSLS8doGVosBzBsNjQdvxs+9CXL/Jpy+IRNdNvXx/xyM1yIBfHdgMm9xyWmNzp7xGbN6j2u0LLq3ttj8wd8vHNcWibooAAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/54305603eb214d087f016d798d77a64d/becf2/debugging.png","srcSet":"/static/54305603eb214d087f016d798d77a64d/1c872/debugging.png 175w,\n/static/54305603eb214d087f016d798d77a64d/3fd51/debugging.png 350w,\n/static/54305603eb214d087f016d798d77a64d/becf2/debugging.png 700w","sizes":"(min-width: 700px) 700px, 100vw"},"sources":[{"srcSet":"/static/54305603eb214d087f016d798d77a64d/5a1f0/debugging.webp 175w,\n/static/54305603eb214d087f016d798d77a64d/bb551/debugging.webp 350w,\n/static/54305603eb214d087f016d798d77a64d/efd8f/debugging.webp 700w","type":"image/webp","sizes":"(min-width: 700px) 700px, 100vw"}]},"width":700,"height":300}},"publicURL":"/static/54305603eb214d087f016d798d77a64d/debugging.png"}}}}]}},"pageContext":{"slug":"/debugging/webCloseError/"}},"staticQueryHashes":[],"slicesMap":{}}